#!/usr/bin/make -f

ifneq ($(DEB_HOST_GNU_TYPE),$(DEB_BUILD_GNU_TYPE))
CC=$(DEB_HOST_GNU_TYPE)-gcc
CXX=$(DEB_HOST_GNU_TYPE)-g++
CROSS_CPPFLAGS=-I/usr/$(DEB_HOST_GNU_TYPE)/include/$(DEB_HOST_GNU_TYPE)
CROSS_INCDIR=/usr/$(DEB_HOST_GNU_TYPE)/include /usr/$(DEB_HOST_GNU_TYPE)/include/$(DEB_HOST_GNU_TYPE) /usr/$(DEB_HOST_GNU_TYPE)/include/dbus-1.0 /usr/$(DEB_HOST_GNU_TYPE)/lib/dbus-1.0/include
CROSS_LDFLAGS=
CROSS_LIBDIR=/usr/$(DEB_HOST_GNU_TYPE)/lib
else
CC=gcc
CXX=g++
CROSS_CPPFLAGS=
CROSS_INCDIR=/usr/include/dbus-1.0 /usr/lib/dbus-1.0/include
CROSS_LDFLAGS=
CROSS_LIBDIR=
endif

ifeq (arm-linux-gnueabi,$(DEB_HOST_GNU_TYPE))
CROSS_CPPFLAGS+=-march=armv4t
ifeq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
CROSS_CPPFLAGS+=-fomit-frame-pointer -finline-functions -falign-functions=2 -falign-loops=2 -falign-jumps=2 -mtune=arm920t -msoft-float
endif
endif

CFLAGS=-pipe $(shell dpkg-buildflags --get CFLAGS) $(CROSS_CPPFLAGS)
LDFLAGS=$(shell dpkg-buildflags --get LDFLAGS) $(CROSS_LDFLAGS)

CONFIGURE := $(CURDIR)/configure
LANGUAGES := $(shell ls i18n/ | xargs echo | sed 's/ /,/g')

TOOLCHAIN := linux-native-g++

%:
	dh $@

override_dh_testdir:
	dh_testdir
	git checkout -f
	git submodule init
	git submodule update
	scripts/git-clean.sh
	git apply devices/gta04/patches/restart-when-modem-stops-working.patch

	# Make mokofaen default theme for debian package
	sed -i 's/finxi/mokofaen/g' devices/neo/src/server/core_server/etc/default/Trolltech/qpe.conf
	sed -i 's/finxi/mokofaen/g' devices/gta04/src/server/core_server/etc/default/Trolltech/qpe.conf
	sed -i 's/=background/=herbe_mouillee/g' devices/neo/src/server/core_server/etc/default/Trolltech/qpe.conf
	sed -i 's/=background/=herbe_mouillee/g' devices/gta04/src/server/core_server/etc/default/Trolltech/qpe.conf

	# Patch the qmake.conf file with proper toolchain configuration
	sed -i 's:^\(QMAKE_CC[ \t]*=\).*$$:\1 '"$(CC):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CXX[ \t]*=\).*$$:\1 '"$(CXX):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LINK[ \t]*=\).*$$:\1 '"$(CXX):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LINK_SHLIB[ \t]*=\).*$$:\1 '"$(CXX):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CFLAGS[ \t]*=\).*$$:\1 '"$(CFLAGS):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CFLAGS_RELEASE[ \t]*=\).*$$:\1 :' devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CFLAGS_DEBUG[ \t]*=\).*$$:\1 :' devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_INCDIR[ \t]*=\).*$$:\1 '"$(CROSS_INCDIR):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LIBDIR[ \t]*=\).*$$:\1 '"$(CROSS_LIBDIR):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LFLAGS[ \t]*=\).*$$:\1 '"$(LDFLAGS):" devices/neo/mkspecs/qws/$(TOOLCHAIN)/qmake.conf

	sed -i 's:^\(QMAKE_CC[ \t]*=\).*$$:\1 '"$(CC):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CXX[ \t]*=\).*$$:\1 '"$(CXX):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LINK[ \t]*=\).*$$:\1 '"$(CXX):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LINK_SHLIB[ \t]*=\).*$$:\1 '"$(CXX):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CFLAGS[ \t]*=\).*$$:\1 '"$(CFLAGS):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CFLAGS_RELEASE[ \t]*=\).*$$:\1 :' devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_CFLAGS_DEBUG[ \t]*=\).*$$:\1 :' devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_INCDIR[ \t]*=\).*$$:\1 '"$(CROSS_INCDIR):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LIBDIR[ \t]*=\).*$$:\1 '"$(CROSS_LIBDIR):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf
	sed -i 's:^\(QMAKE_LFLAGS[ \t]*=\).*$$:\1 '"$(LDFLAGS):" devices/gta04/mkspecs/qws/$(TOOLCHAIN)/qmake.conf

override_dh_auto_configure:
	# Add built qt to LD path to avoid libQtSql.so.4 missing error
	export LD_LIBRARY_PATH=$(LD_LIBRARY_PATH):$(PWD)/../build/qtopiacore/host/lib/

	# Fix wrong filename for libjscore.a
	# http://qt-project.org/forums/viewthread/12732
	mkdir -p $(PWD)/../build-neo/qtopiacore/target/src/3rdparty/webkit/JavaScriptCore/release/
	mkdir -p $(PWD)/../build-gta04/qtopiacore/target/src/3rdparty/webkit/JavaScriptCore/release/
	ln -s $(PWD)/../build-neo/qtopiacore/target/src/3rdparty/webkit/JavaScriptCore/release/jscore. $(PWD)/../build-neo/qtopiacore/target/src/3rdparty/webkit/JavaScriptCore/release/libjscore.a
	ln -s $(PWD)/../build-gta04/qtopiacore/target/src/3rdparty/webkit/JavaScriptCore/release/jscore. $(PWD)/../build-gta04/qtopiacore/target/src/3rdparty/webkit/JavaScriptCore/release/libjscore.a

	# Qt Extended configuration step
	mkdir -p ../build-neo
	cd ../build-neo && "$(CONFIGURE)" -device neo -system-qt -xplatform $(TOOLCHAIN) -remove-module pkgmanagement -languages $(LANGUAGES) -l dbus-1 -I /usr/include/dbus-1.0/ -I /usr/lib/dbus-1.0/include

	mkdir -p ../build-gta04
	cd ../build-gta04 && "$(CONFIGURE)" -device gta04 -system-qt -xplatform $(TOOLCHAIN) -remove-module pkgmanagement -languages $(LANGUAGES) -l dbus-1 -I /usr/include/dbus-1.0/ -I /usr/lib/dbus-1.0/include

override_dh_auto_build:
	$(MAKE) -C ../build-neo
	$(MAKE) -C ../build-gta04

override_dh_auto_clean:
	rm -fr ../build-gta04
	rm -fr ../build-neo
	rm -f sdk/LICENSE.QtopiaGPL

override_dh_auto_install:
	$(MAKE) -C ../build-neo install
	mkdir -p debian/tmp-neo/opt/qtmoko
	cp -r ../build-neo/image/* debian/tmp-neo/opt/qtmoko

	$(MAKE) -C ../build-gta04 install
	mkdir -p debian/tmp-gta04/opt/qtmoko
	cp -r ../build-gta04/image/* debian/tmp-gta04/opt/qtmoko

	# remove patented stuff - can be installed via package later
	rm -f debian/tmp-neo/opt/qtmoko/plugins/codecs/libmadplugin.so
	rm -f debian/tmp-neo/opt/qtmoko/lib/libmad.so.0
	rm -f debian/tmp-gta04/opt/qtmoko/plugins/codecs/libmadplugin.so
	rm -f debian/tmp-gta04/opt/qtmoko/lib/libmad.so.0

	# symlink to ttfont installed together with X
	rm -rf debian/tmp-neo/opt/qtmoko/lib/fonts
	rm -rf debian/tmp-gta04/opt/qtmoko/lib/fonts

	# Install missing dependency for qt_plugins/script/libqtscriptdbus.so
	install -m"a+r,u+w" ../build-neo/qtopiacore/target/lib/libQtScript.so.4.7.4 debian/tmp-neo/opt/qtmoko/lib
	install -m"a+r,u+w" ../build-gta04/qtopiacore/target/lib/libQtScript.so.4.7.4 debian/tmp-gta04/opt/qtmoko/lib	
	
	# Install libQtDeclarative so that dh_shlibdeps does not complain
	install -m"a+r,u+w" ../build-neo/qtopiacore/target/lib/libQtDeclarative* debian/tmp-neo/opt/qtmoko/lib/
	install -m"a+r,u+w" ../build-gta04/qtopiacore/target/lib/libQtDeclarative* debian/tmp-gta04/opt/qtmoko/lib/

override_dh_makeshlibs:
	dh_makeshlibs -n

override_dh_shlibdeps:
	#dh_shlibdeps -l$(CURDIR)/debian/qtmoko-$(QTMOKO_DEVICE)/opt/qtmoko/lib
